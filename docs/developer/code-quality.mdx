---
title: "Code Quality Gates"
description: "The required quality checks for any change that touches packages/** in this repo."
---

This repository targets a high-signal, strict quality baseline for the Node.js/TypeScript codebase.

The rules below are **required** for any change that touches code under `packages/**`.

## Required gates (must pass)

Run from repo root:

```bash
bun install
bun run format:check
bun run schemas:check
bun run agents:check
bun run typecheck
bun run lint
bun run coverage
bun run coverage:significant
```

`bun run ci` is the recommended single command.

## Scoped checks (faster dev loop)

When you only need to validate a specific package during development, use the scoped CI scripts:

```bash
bun run ci:agentplane
bun run ci:core
bun run ci:recipes
bun run ci:spec
bun run ci:testkit
```

These run Prettier, ESLint, TypeScript, and tests only for the selected package. Full `bun run ci` is still required before merge/push.

## Enforcement

### Local (git hooks)

This repo installs `pre-commit` and `pre-push` hooks via `lefthook`. Hooks are a mandatory quality gate and must pass before commit or push:

```bash
pre-commit:
- bun run format:check
- bun run lint
- bun run test:precommit

pre-push:
- node scripts/check-release-notes.mjs
- bun run test:critical
- bun run test:full
```

Hooks are installed automatically on `bun install` (via the root `postinstall` script). If you ever need to reinstall them:

```bash
bun run hooks:install
```

> Do not bypass hooks with `git commit --no-verify`. Fix the failures and rerun.

### CI (GitHub Actions)

GitHub CI runs explicit gates on pull requests and pushes to `main`:

- `format:check`
- `schemas:check`
- `agents:check`
- `build` (before lint, for type-aware linting)
- `lint`
- `test:fast`
- `test:critical`
- significant coverage guard for critical files

## Tests

- Any new behavior MUST include tests.
- Bug fixes MUST include a regression test.
- Tests run via `vitest` and should live next to code: `packages/<pkg>/src/**/*.test.ts`.

## Coverage

- Coverage is enforced via `vitest` thresholds and additional significant-file checks in `scripts/check-significant-coverage.mjs`.
- For high-risk files, repository policy expects branch coverage to stay above the configured floor.

## Critical file writes

Critical task artifacts (for example `.agentplane/tasks/**` and `tasks.json`) must be written atomically.
Use the `atomicWriteFile` helper from `@agentplaneorg/core` to avoid partial writes.

## Linting and formatting

- ESLint is required and enforced via `eslint.config.cjs`.
- Prettier is the single source of truth for formatting.
- Do not commit formatting-only diffs mixed with behavior changes unless necessary.

## Type safety

- `strict` TypeScript is required.
- Avoid `any`. If you must, document why and keep it local.
