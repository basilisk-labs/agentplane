---
title: "CLI contract"
description: "Stable command parsing, exit codes, and JSON error behavior for the current CLI."
---

This document describes the stable CLI contract for `agentplane` command parsing and error behavior.

Scope: global flags, parsing rules, exit codes, and JSON error output.

## 1) Invocation model

```
agentplane [global-flags] <command> [args/options]
```

Supported global flags:

- `--root <path>`: resolve project from an explicit root.
- `--json-errors`: print machine-readable errors.
- `--allow-network`: allow optional network actions that would otherwise be skipped by approval policy.
- `--no-update-check`: skip update check call.
- `--help`, `-h`, `--version`, `-v`.

### 1.1 Global flag scoping (spec-driven CLI)

Scoped global flags (`--json-errors`, `--allow-network`) are recognized only before the command id. For example:

- `agentplane --json-errors task list ...` enables JSON error output.
- `agentplane help --json` emits JSON help output and does not enable JSON error mode.
- `agentplane task list --json-errors` treats `--json-errors` as a command flag candidate, not global mode.

## 2) Exit codes

The CLI uses stable exit codes for common failure classes:

| Code | Meaning                                                         |
| ---: | --------------------------------------------------------------- |
|    0 | Success                                                         |
|    2 | Usage error (invalid args, missing required args)               |
|    3 | Validation error (schema/invariants)                            |
|    4 | Filesystem / IO error                                           |
|    5 | Git / workflow guardrail error                                  |
|    6 | Backend error (local or remote backend)                         |
|    7 | Network error (only for commands that explicitly allow network) |
|    1 | Any other error (unexpected/unclassified)                       |

## 3) `--json-errors` format

When `--json-errors` is provided and a command fails, the CLI prints one JSON object to stdout:

```json
{
  "error": {
    "code": "E_USAGE",
    "message": "Missing required argument: --root",
    "context": {
      "command": "init",
      "args": ["--yes"]
    }
  }
}
```

Rules:

- JSON errors are written to stdout; human-readable diagnostics go to stderr only when `--json-errors` is not set.
- `error.code` is a stable string enum (`E_USAGE`, `E_VALIDATION`, `E_IO`, `E_GIT`, `E_BACKEND`, `E_NETWORK`, `E_INTERNAL`).
- `context` is optional and must not include secrets.
- No additional keys are emitted; the schema is exact.

## 4) Command registry and loading

Command definitions are registered in `packages/agentplane/src/cli/run-cli/command-catalog.ts`.
The catalog keeps command specs lightweight and loads command runtime handlers lazily.

This split keeps `agentplane help` fast and reduces accidental startup cost from heavy imports.

## 5) Help and role surfaces

- `agentplane quickstart` and `agentplane role <ROLE>` are generated from `packages/agentplane/src/cli/command-guide.ts`.
- `agentplane role <ROLE>` can display:
- built-in CLI role guide blocks
- and project-local `.agentplane/agents/<ROLE>.json` profile details when available.
- For unknown role requests, CLI prints known built-in roles and discovered project role ids.

## 6) Contract boundaries

- `agentplane help --compact` is a human output convenience, not a machine schema.
- `agentplane help --json` is machine-readable help output.
- `--json-errors` is for failed command output only.
- Command descriptions and examples may change, but option names, required flags, error shapes, and exit code mapping are treated as stable contract surface.

## 7) Source references

- Parser and global flags:
  - `packages/agentplane/src/cli/run-cli.ts`
- Help/role guide text:
  - `packages/agentplane/src/cli/command-guide.ts`
- Command catalog:
  - `packages/agentplane/src/cli/run-cli/command-catalog.ts`

For command-level help JSON schema details, see [CLI help JSON contract](cli-help-json).
