name: Pre-publish Checks

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to validate (vX.Y.Z). Leave empty to validate current ref."
        required: false

permissions:
  contents: read

concurrency:
  group: prepublish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-24.04
    outputs:
      core: ${{ steps.filter.outputs.core }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: .github/path-filters.yml

  prepublish-matrix:
    needs: changes
    if: github.event_name == 'workflow_dispatch' || needs.changes.outputs.core == 'true'
    name: Pre-publish checks (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-24.04
          - windows-latest
    env:
      GIT_AUTHOR_NAME: agentplane-ci
      GIT_AUTHOR_EMAIL: agentplane-ci@example.com
      GIT_COMMITTER_NAME: agentplane-ci
      GIT_COMMITTER_EMAIL: agentplane-ci@example.com
    steps:
      - name: Resolve target ref
        id: target
        shell: bash
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            echo "ref=refs/tags/${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ github.ref }}" >> "$GITHUB_OUTPUT"
          fi
      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.target.outputs.ref }}
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Cache Bun artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-
      - run: bun install --frozen-lockfile --ignore-scripts
      - name: Format (check)
        run: bun run format:check
      - name: Schemas (check)
        run: bun run schemas:check
      - name: Agent templates (check)
        run: bun run agents:check
      - name: Release parity (check)
        run: bun run release:parity
      - name: Build
        run: bun run build
      - name: CLI docs (generated reference check)
        run: bun run docs:cli:check
      - name: Lint
        run: bun run lint:core
      - name: Unit tests (fast)
        if: matrix.os == 'ubuntu-24.04'
        run: bun run test:fast
      - name: CLI E2E (critical)
        if: matrix.os == 'ubuntu-24.04'
        run: bun run test:critical
      - name: Significant File Coverage (guard)
        if: matrix.os == 'ubuntu-24.04'
        shell: bash
        run: |
          bunx vitest run \
            packages/agentplane/src/commands/guard/impl/allow.test.ts \
            packages/agentplane/src/commands/guard/impl/close-message.test.ts \
            packages/agentplane/src/commands/guard/impl/commands.unit.test.ts \
            packages/agentplane/src/commands/guard/impl/policy.test.ts \
            packages/agentplane/src/commands/guard/impl/comment-commit.test.ts \
            packages/agentplane/src/cli/run-cli.core.guard.test.ts \
            --coverage \
            --coverage.reporter=json \
            --coverage.include='packages/agentplane/src/commands/guard/**'
          bun run coverage:significant
      - name: Unit tests (platform-critical)
        if: matrix.os == 'windows-latest'
        run: bun test packages/agentplane/src/commands/shared/pr-meta.test.ts packages/agentplane/src/commands/scenario/impl/commands.test.ts packages/agentplane/src/cli/run-cli.core.init-upgrade-backend.test.ts
