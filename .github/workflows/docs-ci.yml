name: Docs CI

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-24.04
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs:
              - "website/**"
              - "docs/**"
              - "DESIGN.md"
              - "scripts/generate-website-docs.mjs"
              - "scripts/check-design-language.mjs"
              - "packages/**"
              - "package.json"
              - "bun.lock"
              - ".github/workflows/docs-ci.yml"

  docs:
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install root dependencies
        run: bun install --frozen-lockfile --ignore-scripts
      - name: Install website dependencies
        run: bun install --cwd website --frozen-lockfile --ignore-scripts
      - name: Generate docs from code
        run: bun run docs:site:generate
      - name: Typecheck website
        run: bun run docs:site:typecheck
      - name: Build website
        run: bun run docs:site:build
      - name: Validate design language constraints
        run: bun run docs:site:check:design
