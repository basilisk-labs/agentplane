name: Publish to npm

on:
  push:
    branches:
      - main
    paths:
      - "packages/core/package.json"
      - "packages/agentplane/package.json"
      - "docs/releases/**"
      - ".github/workflows/publish.yml"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to evaluate for release (default: main)"
        required: false
        default: "main"

permissions:
  contents: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Detect release candidate
    runs-on: ubuntu-24.04
    outputs:
      should_publish: ${{ steps.detect.outputs.should_publish }}
      version: ${{ steps.detect.outputs.version }}
      tag: ${{ steps.detect.outputs.tag }}
      ref: ${{ steps.ref.outputs.ref }}
    steps:
      - name: Resolve ref
        id: ref
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ref=${{ github.event.inputs.ref }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi
      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.ref }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Detect publish target
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          VERSION_CORE=$(node -p "JSON.parse(require('node:fs').readFileSync('packages/core/package.json','utf8')).version")
          VERSION_CLI=$(node -p "JSON.parse(require('node:fs').readFileSync('packages/agentplane/package.json','utf8')).version")
          CORE_DEP=$(node -p "JSON.parse(require('node:fs').readFileSync('packages/agentplane/package.json','utf8')).dependencies['@agentplaneorg/core']")
          if [ "$VERSION_CORE" != "$VERSION_CLI" ] || [ "$VERSION_CORE" != "$CORE_DEP" ]; then
            echo "release parity failed: core=$VERSION_CORE cli=$VERSION_CLI dep=$CORE_DEP" >&2
            exit 1
          fi

          VERSION="$VERSION_CLI"
          TAG="v${VERSION}"
          NOTES="docs/releases/${TAG}.md"
          if [ ! -f "$NOTES" ]; then
            echo "missing release notes: $NOTES" >&2
            exit 1
          fi

          CORE_PUBLISHED=false
          CLI_PUBLISHED=false
          if npm view "@agentplaneorg/core@${VERSION}" version >/dev/null 2>&1; then CORE_PUBLISHED=true; fi
          if npm view "agentplane@${VERSION}" version >/dev/null 2>&1; then CLI_PUBLISHED=true; fi

          if [ "$CORE_PUBLISHED" != "$CLI_PUBLISHED" ]; then
            echo "registry drift: core=${CORE_PUBLISHED} agentplane=${CLI_PUBLISHED} for ${VERSION}" >&2
            exit 1
          fi

          if [ "$CORE_PUBLISHED" = "true" ]; then
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          else
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

  verify:
    needs: detect
    if: needs.detect.outputs.should_publish == 'true'
    name: Release checks (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-24.04
          - windows-latest
    env:
      GIT_AUTHOR_NAME: agentplane-ci
      GIT_AUTHOR_EMAIL: agentplane-ci@example.com
      GIT_COMMITTER_NAME: agentplane-ci
      GIT_COMMITTER_EMAIL: agentplane-ci@example.com
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect.outputs.ref }}
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Cache Bun artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-
      - run: bun install --frozen-lockfile --ignore-scripts
      - name: Full release checks (Linux)
        if: matrix.os == 'ubuntu-24.04'
        run: bun run release:ci-check
      - name: Windows release checks
        if: matrix.os == 'windows-latest'
        run: |
          bun run format:check
          bun run schemas:check
          bun run agents:check
          bun run release:parity
          bun run build
          bun run docs:cli:check
          bun run lint
          bun test packages/agentplane/src/commands/shared/pr-meta.test.ts packages/agentplane/src/commands/scenario/impl/commands.test.ts packages/agentplane/src/cli/run-cli.core.init-upgrade-backend.test.ts

  publish:
    needs: [detect, verify]
    if: needs.detect.outputs.should_publish == 'true'
    environment: npm
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    env:
      NPM_CONFIG_PROVENANCE: "true"
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
      NPM_CONFIG_USERCONFIG: ${{ github.workspace }}/.npmrc
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.detect.outputs.ref }}
          fetch-depth: 0
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm i -g npm@11.5.1
      - name: Cache Bun artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-
      - run: bun install --frozen-lockfile --ignore-scripts
      - name: Validate release notes
        run: node scripts/check-release-notes.mjs --tag "${{ needs.detect.outputs.tag }}"
      - name: Validate release versions
        run: node scripts/check-release-version.mjs --tag "${{ needs.detect.outputs.tag }}"
      - name: Ensure tag does not exist on origin
        shell: bash
        run: |
          set -euo pipefail
          if git ls-remote --exit-code --tags origin "refs/tags/${{ needs.detect.outputs.tag }}" >/dev/null 2>&1; then
            echo "tag already exists on origin: ${{ needs.detect.outputs.tag }}" >&2
            exit 1
          fi
      - name: Build release packages
        run: bun run release:check
      - name: Build upgrade bundle assets
        shell: bash
        run: |
          set -euo pipefail
          tar -czf agentplane-upgrade.tar.gz -C packages/agentplane/assets .
          sha256sum agentplane-upgrade.tar.gz > agentplane-upgrade.tar.gz.sha256
      - run: printf "registry=https://registry.npmjs.org/\n" > "$NPM_CONFIG_USERCONFIG"
      - name: Publish @agentplaneorg/core
        working-directory: packages/core
        shell: bash
        run: |
          set -euo pipefail
          npm publish --provenance --access public --tag latest
      - name: Publish agentplane
        working-directory: packages/agentplane
        shell: bash
        run: |
          set -euo pipefail
          npm publish --provenance --access public --tag latest
      - name: Post-publish npm smoke
        run: bun run release:smoke:published
      - name: Push release tag
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ needs.detect.outputs.tag }}"
          git push origin "refs/tags/${{ needs.detect.outputs.tag }}"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.detect.outputs.tag }}
          body_path: docs/releases/${{ needs.detect.outputs.tag }}.md
          files: |
            agentplane-upgrade.tar.gz
            agentplane-upgrade.tar.gz.sha256
