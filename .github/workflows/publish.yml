name: Publish to npm

on:
  push:
    tags:
      - "v*"
  create: {}
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (vX.Y.Z)"
        required: false

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'create' && github.event.ref_type == 'tag' && startsWith(github.event.ref, 'v')) ||
      (github.event_name == 'workflow_dispatch')
    environment: npm
    runs-on: ubuntu-latest
    env:
      NPM_CONFIG_PROVENANCE: "true"
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
      NPM_CONFIG_USERCONFIG: ${{ github.workspace }}/.npmrc
    steps:
      - name: Resolve release tag
        id: release_tag
        run: |
          tag=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.tag }}" ]; then
            tag="${{ inputs.tag }}"
          elif [ "${{ github.ref_type }}" = "tag" ] && [ -n "${{ github.ref_name }}" ]; then
            tag="${{ github.ref_name }}"
          elif [ "${{ github.event.ref_type }}" = "tag" ] && [ -n "${{ github.event.ref }}" ]; then
            tag="${{ github.event.ref }}"
          fi
          if [ -z "$tag" ]; then
            echo "Missing release tag. Run workflow_dispatch with input 'tag' (vX.Y.Z)." >&2
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
      - uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ steps.release_tag.outputs.tag }}
      - name: Validate release notes
        run: node scripts/check-release-notes.mjs --tag "${{ steps.release_tag.outputs.tag }}"
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm i -g npm@11.5.1
      - run: bun install --frozen-lockfile --ignore-scripts
      - run: bun run --filter=@agentplaneorg/core build
      - run: bun run --filter=agentplane build
      - run: printf "registry=https://registry.npmjs.org/\n" > "$NPM_CONFIG_USERCONFIG"
      - run: npm publish --provenance --access public
        working-directory: packages/core
      - run: npm publish --provenance --access public
        working-directory: packages/agentplane
