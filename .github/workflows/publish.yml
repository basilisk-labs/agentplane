name: Publish to npm

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to release from (branch, tag, or SHA)"
        required: true
        default: "main"
      tag:
        description: "Optional override tag (must match v<package-version> if provided)"
        required: false

permissions:
  contents: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.ref }}
  cancel-in-progress: true

jobs:
  verify:
    name: Release checks (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-24.04
          - windows-latest
    env:
      GIT_AUTHOR_NAME: agentplane-ci
      GIT_AUTHOR_EMAIL: agentplane-ci@example.com
      GIT_COMMITTER_NAME: agentplane-ci
      GIT_COMMITTER_EMAIL: agentplane-ci@example.com
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Cache Bun artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-
      - run: bun install --frozen-lockfile --ignore-scripts
      - name: Full release checks (Linux)
        if: matrix.os == 'ubuntu-24.04'
        run: bun run release:ci-check
      - name: Windows release checks
        if: matrix.os == 'windows-latest'
        run: |
          bun run format:check
          bun run schemas:check
          bun run agents:check
          bun run release:parity
          bun run build
          bun run docs:cli:check
          bun run lint
          bun test packages/agentplane/src/commands/shared/pr-meta.test.ts packages/agentplane/src/commands/scenario/impl/commands.test.ts packages/agentplane/src/cli/run-cli.core.init-upgrade-backend.test.ts

  publish:
    needs: verify
    environment: npm
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    env:
      NPM_CONFIG_PROVENANCE: "true"
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
      NPM_CONFIG_USERCONFIG: ${{ github.workspace }}/.npmrc
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}
          fetch-depth: 0
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm i -g npm@11.5.1
      - name: Cache Bun artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-
      - run: bun install --frozen-lockfile --ignore-scripts
      - name: Resolve release tag
        id: release_tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(node -p "JSON.parse(require('node:fs').readFileSync('packages/agentplane/package.json','utf8')).version")
          TAG="v${VERSION}"
          if [ -n "${{ github.event.inputs.tag }}" ] && [ "${{ github.event.inputs.tag }}" != "$TAG" ]; then
            echo "input tag does not match package version: input=${{ github.event.inputs.tag }} expected=$TAG" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
      - name: Ensure release tag does not exist
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.release_tag.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "tag already exists locally: $TAG" >&2
            exit 1
          fi
          if git ls-remote --exit-code --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "tag already exists on origin: $TAG" >&2
            exit 1
          fi
      - name: Validate release notes
        run: node scripts/check-release-notes.mjs --tag "${{ steps.release_tag.outputs.tag }}"
      - name: Validate release versions
        run: node scripts/check-release-version.mjs --tag "${{ steps.release_tag.outputs.tag }}"
      - name: Build release packages
        run: bun run release:check
      - name: Build upgrade bundle assets
        shell: bash
        run: |
          set -euo pipefail
          tar -czf agentplane-upgrade.tar.gz -C packages/agentplane/assets .
          sha256sum agentplane-upgrade.tar.gz > agentplane-upgrade.tar.gz.sha256
      - run: printf "registry=https://registry.npmjs.org/\n" > "$NPM_CONFIG_USERCONFIG"
      - name: Publish @agentplaneorg/core
        working-directory: packages/core
        shell: bash
        run: |
          set -euo pipefail
          NAME=$(node -p "JSON.parse(require('node:fs').readFileSync('package.json','utf8')).name")
          VERSION=$(node -p "JSON.parse(require('node:fs').readFileSync('package.json','utf8')).version")
          if npm view "$NAME@$VERSION" version >/dev/null 2>&1; then
            echo "version already exists in npm registry: $NAME@$VERSION" >&2
            exit 1
          fi
          npm publish --provenance --access public --tag latest
      - name: Publish agentplane
        working-directory: packages/agentplane
        shell: bash
        run: |
          set -euo pipefail
          NAME=$(node -p "JSON.parse(require('node:fs').readFileSync('package.json','utf8')).name")
          VERSION=$(node -p "JSON.parse(require('node:fs').readFileSync('package.json','utf8')).version")
          if npm view "$NAME@$VERSION" version >/dev/null 2>&1; then
            echo "version already exists in npm registry: $NAME@$VERSION" >&2
            exit 1
          fi
          npm publish --provenance --access public --tag latest
      - name: Post-publish npm smoke
        run: bun run release:smoke:published
      - name: Push release tag
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.release_tag.outputs.tag }}"
          git push origin "refs/tags/${{ steps.release_tag.outputs.tag }}"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          body_path: docs/releases/${{ steps.release_tag.outputs.tag }}.md
          files: |
            agentplane-upgrade.tar.gz
            agentplane-upgrade.tar.gz.sha256
