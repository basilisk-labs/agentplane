name: Publish to npm

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (vX.Y.Z)"
        required: false

permissions:
  contents: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch')
    environment: npm
    runs-on: ubuntu-24.04
    env:
      NPM_CONFIG_PROVENANCE: "true"
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
      NPM_CONFIG_USERCONFIG: ${{ github.workspace }}/.npmrc
    steps:
      - name: Resolve release tag
        id: release_tag
        run: |
          tag=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.tag }}" ]; then
            tag="${{ inputs.tag }}"
          elif [ "${{ github.ref_type }}" = "tag" ] && [ -n "${{ github.ref_name }}" ]; then
            tag="${{ github.ref_name }}"
          elif [ "${{ github.event.ref_type }}" = "tag" ] && [ -n "${{ github.event.ref }}" ]; then
            tag="${{ github.event.ref }}"
          fi
          if [ -z "$tag" ]; then
            echo "Missing release tag. Run workflow_dispatch with input 'tag' (vX.Y.Z)." >&2
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
      - uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ steps.release_tag.outputs.tag }}
      - name: Validate release notes
        run: node scripts/check-release-notes.mjs --tag "${{ steps.release_tag.outputs.tag }}"
      - name: Validate release versions
        run: node scripts/check-release-version.mjs --tag "${{ steps.release_tag.outputs.tag }}"
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.6"
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm i -g npm@11.5.1
      - name: Cache Bun artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-
      - run: bun install --frozen-lockfile --ignore-scripts
      # Server-side gate: do not publish if formatting/lint/tests fail.
      # Hooks are local and can be bypassed; publish must be deterministic.
      - name: Format (check)
        run: bun run format:check
      - name: Schemas (check)
        run: bun run schemas:check
      - name: Agent templates (check)
        run: bun run agents:check
      - run: bun run --filter=@agentplaneorg/core build
      - run: bun run --filter=agentplane build
      - name: Lint
        run: bun run lint
      - name: Tests (Full)
        run: bun run test:full
      - name: Build upgrade bundle assets
        run: |
          set -euo pipefail
          tar -czf agentplane-upgrade.tar.gz -C packages/agentplane/assets .
          sha256sum agentplane-upgrade.tar.gz > agentplane-upgrade.tar.gz.sha256
      - run: printf "registry=https://registry.npmjs.org/\n" > "$NPM_CONFIG_USERCONFIG"
      # npm no longer allows implicitly moving `latest` to a lower semver than the
      # current `latest` (e.g. publishing 0.2.5 after 0.3.0). Use an explicit tag
      # so patch releases on an older minor line can still publish and take over
      # the `latest` dist-tag when intended.
      - name: Publish @agentplaneorg/core (idempotent)
        working-directory: packages/core
        run: |
          set -euo pipefail
          NAME=$(node -p "JSON.parse(require('node:fs').readFileSync('package.json','utf8')).name")
          VERSION=$(node -p "JSON.parse(require('node:fs').readFileSync('package.json','utf8')).version")
          if npm view "$NAME@$VERSION" version >/dev/null 2>&1; then
            echo "skip: already published $NAME@$VERSION"
            exit 0
          fi
          if npm publish --provenance --access public --tag latest; then
            echo "published: $NAME@$VERSION"
            exit 0
          fi
          if npm view "$NAME@$VERSION" version >/dev/null 2>&1; then
            echo "skip-after-race: already published $NAME@$VERSION"
            exit 0
          fi
          echo "publish failed for $NAME@$VERSION" >&2
          exit 1
      - name: Publish agentplane (idempotent)
        working-directory: packages/agentplane
        run: |
          set -euo pipefail
          NAME=$(node -p "JSON.parse(require('node:fs').readFileSync('package.json','utf8')).name")
          VERSION=$(node -p "JSON.parse(require('node:fs').readFileSync('package.json','utf8')).version")
          if npm view "$NAME@$VERSION" version >/dev/null 2>&1; then
            echo "skip: already published $NAME@$VERSION"
            exit 0
          fi
          if npm publish --provenance --access public --tag latest; then
            echo "published: $NAME@$VERSION"
            exit 0
          fi
          if npm view "$NAME@$VERSION" version >/dev/null 2>&1; then
            echo "skip-after-race: already published $NAME@$VERSION"
            exit 0
          fi
          echo "publish failed for $NAME@$VERSION" >&2
          exit 1
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          body_path: docs/releases/${{ steps.release_tag.outputs.tag }}.md
          files: |
            agentplane-upgrade.tar.gz
            agentplane-upgrade.tar.gz.sha256
