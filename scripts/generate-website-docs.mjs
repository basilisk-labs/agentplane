import { mkdir, readdir, readFile, writeFile } from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, "..");
const packagesDir = path.join(repoRoot, "packages");
const outputDir = path.join(repoRoot, "docs", "reference");
const outputPath = path.join(outputDir, "generated-reference.mdx");

async function readPackages() {
  const entries = await readdir(packagesDir, { withFileTypes: true });
  const packageDirs = entries
    .filter((entry) => entry.isDirectory())
    .map((entry) => entry.name)
    .toSorted();
  const rows = [];

  for (const dir of packageDirs) {
    const manifestPath = path.join(packagesDir, dir, "package.json");
    try {
      const manifestRaw = await readFile(manifestPath, "utf8");
      const manifest = JSON.parse(manifestRaw);
      rows.push({
        id: dir,
        name: manifest.name ?? dir,
        version: manifest.version ?? "0.0.0",
      });
    } catch {
      // Skip folders without package manifests.
    }
  }

  return rows;
}

async function main() {
  const packages = await readPackages();
  const lines = [
    "---",
    "title: Generated Reference",
    "description: Auto-generated package reference sourced from repository manifests.",
    "sidebar_position: 1",
    "---",
    "",
    "This page is generated by `scripts/generate-website-docs.mjs`.",
    "",
    "## Packages",
    "",
    "| Package | Version | Folder |",
    "| --- | --- | --- |",
    ...packages.map((pkg) => `| \`${pkg.name}\` | \`${pkg.version}\` | \`packages/${pkg.id}\` |`),
    "",
    "## Update Contract",
    "",
    "Whenever package manifests change, this file must be regenerated in CI before website build.",
    "",
  ];

  await mkdir(outputDir, { recursive: true });
  await writeFile(outputPath, `${lines.join("\n")}`, "utf8");
  process.stdout.write(`generated ${path.relative(repoRoot, outputPath)}\n`);
}

await main();
